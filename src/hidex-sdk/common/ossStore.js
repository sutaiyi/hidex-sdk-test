import t from"axios";import{defaluBoootedOss as e,defalutWalletStore as a,HIDEXKEYWORD as o}from"./config";import r from"./browser/passworder";import{environmental as s}from"./utils";const l=(t,e)=>({headers:{"Content-Type":"application/json",Authorization:e,dev:s("",!0,!0)}}),i=new Map,n=async(a,s)=>{try{const s=await t.get("/api/frontend/app/personal/getItem",l(0,a));if(200===s?.status&&200===s?.data?.code){if(s.data?.data?.putBooted){const t=await r.decrypt(o,s.data.data.putBooted),e=JSON.parse(t);return i.set("WalletBooted",e),{...e,passwordStatus:e.booted?1:0,walletStatus:Object.keys(e.walletBooted).length?1:0}}return i.set("WalletBooted",e),e}throw new Error(JSON.stringify(s?.data))}catch(t){return console.log("s3 get error","string"==typeof t,t),{...e,passwordStatus:void 0,walletStatus:void 0,error:-1!==t?.toString()?.indexOf('"code":401')?"failed get s3 code 401":void 0}}},d=async(a,s,d,p,c)=>{let w="/api/frontend/app/personal/setItem";if(!a)return{...e,passwordStatus:void 0,walletStatus:void 0};try{let s=await n(a);if(void 0===s?.walletStatus)throw new Error("Failed get s3 store");if(s&&"all"!==d&&p&&(s[d]=p),"all"==d&&p)if(c)s=e,w="/api/frontend/app/personal/setItem?reset=y";else{if(s.walletBooted&&!p.walletBooted)throw new Error("[Failed set s3 store] 数据比对异常");s=p}i.set("WalletBooted",s);const f=await r.encrypt(o,JSON.stringify(s)),u=await t.post(w,{putBooted:f},l(0,a));if(200===u?.status&&u?.data&&200===u?.data?.code)return s;throw new Error("Failed set s3 store")}catch(t){throw new Error("Failed set s3 store"+t)}},p=async(t,e)=>{const s=await t.getItem("dataCache");if(s&&"object"==typeof s){const t=await r.decrypt(o,JSON.stringify(s)),a=JSON.parse(t);return i.set("WalletStore",a),e?a[e]:a}return i.set("WalletStore",a),a},c=async(t,e,a)=>{let s=i.get("WalletStore");s||(s=await p(t)),s&&"all"!==e&&a&&(s[e]=a),"all"==e&&a&&(s=a),i.set("WalletStore",s);const l=await r.encrypt(o,JSON.stringify(s));return await t.setItem("dataCache",l)},w=()=>{i.clear()},f=()=>i;export const ossStore={getWalletStoreItem:p,setWalletStoreItem:c,getBootedOssItem:n,setBootedOssItem:d,clearWalletMap:w,getWalletMap:f};