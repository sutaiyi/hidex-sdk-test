import*as t from"@project-serum/anchor";import{ASSOCIATED_TOKEN_PROGRAM_ID as e,getAssociatedTokenAddress as o,TOKEN_2022_PROGRAM_ID as n,TOKEN_PROGRAM_ID as r}from"@solana/spl-token";import{ComputeBudgetProgram as a,PublicKey as s,SystemProgram as i,TransactionMessage as c,VersionedTransaction as u}from"@solana/web3.js";import m from"../../../common/abis";import l from"../../../wallet/custom";import{sTokenAddress as p,zero as f}from"../../../common/config";import{AssociateTokenProgram as d,BASE_ACCOUNT_INIT_FEE as g,JUPITER_PROGRAM_ID as w,PROGRAMID as B,PUEM_INSTRUCTION_PREFIX as A,PUMP_AMM_PROGRAM_ID as P,PUMP_PROGRAM_ID as y,SEED_DATA as I,SEED_NONCE as S,SEED_SWAP as h,SEED_TRADE as x,SEED_TRADE_NONCE as b,SOLANA_SYSTEM_PROGRAM_ID as N,SOLANA_SYSTEM_PROGRAM_TRANSFER_ID as L,SUPPORT_CHANGE_PROGRAM_IDS as T,TOKEN_PROGRAM_OWNS as C}from"../config";import{createMemoInstruction as k}from"@solana/spl-memo";export const isBuy=t=>!!t.isBuy;export function initAnchor(e,o){const n=o.getProviderByChain(102),r=new l(e),a=new t.AnchorProvider(n,r,t.AnchorProvider.defaultOptions());t.setProvider(a)}export async function information(e,r,a){initAnchor(r,a);const i=new s(B()),c=new t.Program(m.solanaIDL,i),[u]=await s.findProgramAddress([Buffer.from(I)],i),[l,g]=await s.findProgramAddress([Buffer.from(h)],i),[w,A]=await s.findProgramAddress([Buffer.from(x)],i),P=new s(e.in.address),y=new s(e.out.address),S=new s(d);let b=e.inviter;b=e.inviter!==f&&e.inviter?new s(e.inviter):l;const N=new t.BN(e.amountIn);let L;e.TOKEN_2022?(L=await o(e.isBuy?y:P,r.publicKey,!1,n),console.log("userAtaAccount1 = "+L)):(L=await o(e.isBuy?y:P,r.publicKey,!1),console.log("userAtaAccount2 = "+L));const T=new s(p),C=await o(T,l,!0),k=await o(T,r.publicKey,!1);console.log("userwSolAta = "+k.toBase58()),console.log("wSol = "+T.toBase58());return{program:c,dataPda:u,swapPda:l,tradePda:w,bump2:g,bump3:A,associateTokenProgram:S,tokenOutMint:y,tokenInMint:P,amount:N,userAtaAccount:L,inviterPublic:b,wSol:T,swapWsolPdaAta:C,userwSolAta:k}}export async function priorityFeeInstruction(t,e){return[a.setComputeUnitLimit({units:t}),a.setComputeUnitPrice({microLamports:Math.floor(e*Math.pow(10,6)/t)})]}export async function versionedTra(t,e,o,n){const r=new c({payerKey:e.publicKey,recentBlockhash:o,instructions:t}).compileToV0Message(n),a=new u(r);return a.sign([e]),a}export async function nomalVersionedTransaction(t,e,o){const n=new c({payerKey:e.publicKey,recentBlockhash:o,instructions:t}).compileToV0Message(),r=new u(n);return r.sign([e]),r}export function getTotalFee(t){const e=t.priorityFee||0;let o=t.bribeFee||0;const n=Math.floor(Number(e)+Number(o));if(3===t.tradeType){const t=n,e=BigInt(Math.floor(t))+BigInt(5e3);return console.log("Gmgn -> totalFee",e.toString()),e.toString()}return(BigInt(Math.floor(n))+BigInt(2e4)).toString()}export async function deleteTransactionGasInstruction(t){let e=0;for(;e>=0;){e=-1;for(let o=0;o<t.length;o++){if(t[o].programId.toBase58()==a.programId.toBase58()){e=o,t.splice(o,1);break}}}}export function getTransactionGasLimitUintsInInstruction(t){console.log("指令长度",t.length);let e=0;for(let o=0;o<t.length;o++){const n=t[o];if(n.programId.toBase58()==a.programId.toBase58()&&2===n.data[0]){e=n.data.slice(1).readInt32LE(0);break}}return e}export function isParameterValid(e){const o=new t.BN(e.solLamports),n=new t.BN(e.userwsolAtaAmount),r=new t.BN(e.userWsolAtaLamports),a=new t.BN(e.tokenAtaLamports);if(console.log("lamportsBefore",e.solLamports),console.log("wsolAtaAmountBefore",e.userwsolAtaAmount),console.log("userWsolAtaLamports",e.userWsolAtaLamports),console.log("tokenAtaLamports",e.tokenAtaLamports),o<0||n<0||r<0||a<0)return!1}export async function createSwapPrepareInstruction(t,e,o){return t.isBuy?createBuySwapPrepareInstruction(t,e,o):createSaleSwapPrepareInstruction(t,e,o)}export async function createSimpleSwapCompleteInstruction(t,e,o,n){return t.isBuy?createSimpleBuySwapCompletedInstruction(t,e,o,n):createSimpleSaleSwapCompletedInstruction(t,e,o,n)}export async function createSwapCompleteInstruction(t,e,o){return t.isBuy?createBuySwapCompletedInstruction(t,e,o):createSaleSwapCompletedInstruction(t,e,o)}export async function createBuySwapPrepareInstruction(t,e,o){const{program:n,tradePda:r,userAtaAccount:a,userwSolAta:s}=await information(t,e,o);return console.log("tradePda = "+r.toBase58()),n.methods.buySwapPrepare().accounts({tradeConfigPda:r,userTokenAtaAccount:a,userWsolAtaAccount:s,user:e.publicKey}).instruction()}export async function createBuySwapCompletedInstruction(o,n,a){const{program:s,dataPda:c,swapPda:u,tradePda:m,userAtaAccount:l,userwSolAta:p,inviterPublic:f}=await information(o,n,a),d=new t.BN(o.isPump?2:1),g=new t.BN(o.feeRate),w=new t.BN(1e4*(o.commissionRate||0)),B=new t.BN(o.tradeType>0?0:1);return s.methods.buySwapCompleted(B,d,g,w).accounts({swapPda:u,configPda:c,tradeConfigPda:m,user:n.publicKey,userAtaAccount:l,userWsolAtaAccount:p,inviter:f,associateTokenProgram:e,tokenProgram:r,systemProgram:i.programId}).instruction()}export async function createSaleSwapPrepareInstruction(t,e,o){const{program:n,tradePda:r,userAtaAccount:a,userwSolAta:s}=await information(t,e,o);return n.methods.saleSwapPrepare().accounts({tradeConfigPda:r,userWsolAtaAccount:s,user:e.publicKey,userAtaAccount:a}).instruction()}export async function createClaimInstruction(e,o,n,r){initAnchor(n,r);const a=new s(B()),c=new t.Program(m.solanaIDL,a),[u]=await s.findProgramAddress([Buffer.from(I)],a),[l,p]=await s.findProgramAddress([Buffer.from(h)],a),[f]=await s.findProgramAddress([Buffer.from(S)],a),d=Buffer.from(e,"hex"),g=Buffer.from(o,"hex");return c.methods.claimCommission(p,d,Array.from(g)).accounts({swapPda:l,configPda:u,noncePda:f,user:n.publicKey,ixSysvar:t.web3.SYSVAR_INSTRUCTIONS_PUBKEY,systemProgram:i.programId}).instruction()}export async function createTradeNonceVerifyInstruction(e,o,n){initAnchor(o,n);const r=new s(B()),a=new t.Program(m.solanaIDL,r),[c]=await s.findProgramAddress([Buffer.from(b),o.publicKey.toBuffer()],r);return a.methods.tradeNonceVerify(new t.BN(e)).accounts({tradeNonceAccount:c,signer:o.publicKey,systemProgram:i.programId}).instruction()}export async function getTradeNonce(e,o){initAnchor(e,o);const n=new s(B()),r=new t.Program(m.solanaIDL,n),[a]=await s.findProgramAddress([Buffer.from(b),e.publicKey.toBuffer()],n);try{const t=await r.account.tradeNonce.fetch(a);if(console.log("tradeNonceData:",t),t)return console.log("tradeNonceData:",t.tradeNonce.toNumber()),t.tradeNonce.toNumber()}catch(t){if(t instanceof Error&&t.message.includes("Account does not exist"))return console.log("账户不存在:",a.toBase58()),0}return-1}export async function createEd25519ProgramIx(e,o,n){const r=new s(e),a=Buffer.from(o,"hex"),i=Buffer.from(n,"hex");return t.web3.Ed25519Program.createInstructionWithPublicKey({publicKey:r.toBytes(),message:a,signature:i})}export async function createSaleSwapCompletedInstruction(o,n,a){const{program:s,dataPda:c,swapPda:u,tradePda:m,bump3:l,amount:p,userAtaAccount:f,swapWsolPdaAta:d,wSol:g,userwSolAta:w,inviterPublic:B}=await information(o,n,a),A=new t.BN(o.isPump?2:1),P=new t.BN(o.feeRate),y=new t.BN(1e4*(o.commissionRate||0)),I=new t.BN(o.tradeType>0?0:1);return s.methods.saleSwapCompleted(l,p,I,A,P,y).accounts({swapPda:u,configPda:c,tradeConfigPda:m,wsolMint:g,userWsolAtaAccount:w,swapPdaWsolAtaAccount:d,user:n.publicKey,userAtaAccount:f,inviter:B,associateTokenProgram:e,tokenProgram:r,systemProgram:i.programId}).instruction()}export async function createSimpleBuySwapCompletedInstruction(o,n,a,s){const{program:c,dataPda:u,swapPda:m,tradePda:l,userAtaAccount:p,userwSolAta:f,inviterPublic:d}=await information(o,n,a),g=new t.BN(o.isPump?2:1),w=new t.BN(o.feeRate),B=new t.BN(1e4*(o.commissionRate||0)),A=new t.BN(o.tradeType>0?0:1),P=new t.BN(o.tokenBalance),y=new t.BN(o.solLamports),I=new t.BN(o.userWsolAtaLamports),S=new t.BN(o.tokenAtaLamports),h=new t.BN(s);return c.methods.buySwapCompletedSimple(A,g,w,B,y,I,P,S,h).accounts({swapPda:m,configPda:u,tradeConfigPda:l,user:n.publicKey,userAtaAccount:p,userWsolAtaAccount:f,inviter:d,associateTokenProgram:e,tokenProgram:r,systemProgram:i.programId}).instruction()}export async function createSimpleSaleSwapCompletedInstruction(o,n,a,s){const{program:c,tokenInMint:u,dataPda:m,swapPda:l,tradePda:p,bump3:f,amount:d,userAtaAccount:g,swapWsolPdaAta:w,wSol:B,userwSolAta:A,inviterPublic:P}=await information(o,n,a),y=new t.BN(o.isPump?2:1),I=new t.BN(o.feeRate),S=new t.BN(1e4*(o.commissionRate||0)),h=new t.BN(o.tradeType>0?0:1),x=new t.BN(o.solLamports),b=new t.BN(o.userwsolAtaAmount),N=new t.BN(o.userWsolAtaLamports);console.log("userWsolAtaLamports = "+N);const L=new t.BN(o.tokenAtaLamports),T=new t.BN(s);return c.methods.saleSwapCompletedSimple(f,d,h,y,I,S,x,b,N,L,u.toBase58(),T).accounts({swapPda:l,configPda:m,tradeConfigPda:p,wsolMint:B,userWsolAtaAccount:A,swapPdaWsolAtaAccount:w,user:n.publicKey,userAtaAccount:g,inviter:P,associateTokenProgram:e,tokenProgram:r,systemProgram:i.programId}).instruction()}export async function createTipTransferInstruction(t,e,o){return i.transfer({fromPubkey:t,toPubkey:e,lamports:o})}export function numberToLittleEndianHex(t,e){if(t<0||t>16777215)throw new Error("Number must be between 0 and 16777215 for 3 bytes");const o=new ArrayBuffer(4);new DataView(o).setUint32(0,t,!0);const n=new Uint8Array(o).slice(0,e);return Array.from(n).map(t=>t.toString(16).padStart(2,"0")).join("")}export async function checkAccountCloseInstruction(t,e,o,n){if(t.isBuy)return!1;if(C.indexOf(e.programId.toBase58())<0)return!1;if(BigInt(t.tokenBalance||"0")==BigInt(t.amountIn))return!1;const{userAtaAccount:r}=await information(t,o,n),a=e.keys[0].pubkey.toBase58();return r.toBase58()==a&&(console.log("deleteAta被删除"),!0)}export function getInstructionAmounts(t,e){const o=e.data.toString("hex"),n=e.programId.toBase58();let r="",a="";const s=T.get(n)??0;n!=P.toBase58()&&n!=y.toBase58()||!t.isBuy?n==w.toBase58()?(r=o.substring(o.length-s,o.length-s+16),a=o.substring(o.length-s+16,o.length-s+32)):(r=o.substring(s,s+16),a=o.substring(s+16,s+32)):(r=o.substring(s+16,s+32),a=o.substring(s,s+16));const i=r.match(/.{2}/g)?.reverse().join("")||"",c=BigInt("0x"+i),u=a.match(/.{2}/g)?.reverse().join("")||"";return{input:c,output:BigInt("0x"+u)}}export function getInstructionReplaceDataHex(t,e,o,n,r){let a=n.concat(r);(e==y.toBase58()||e==P.toBase58())&&o.startsWith(A)&&t.isBuy&&(a=r.concat(n));const s=T.get(e)??0;let i;return i=e==w.toBase58()?o.slice(0,o.length-s)+a+o.slice(o.length-s+32):o.slice(0,s)+a+o.slice(s+32),i}export function setTransferInstructionLamports(t,e,o){if(t.data.readUInt32LE(0)===L){const n=Buffer.alloc(8);n.writeBigUInt64LE(o+BigInt(1e3),0);const r=n.toString("hex"),a=e.slice(0,e.length-16)+r;return Buffer.from(a,"hex"),t.data=Buffer.from(a,"hex"),!0}return!1}export function setCreateAccountBySeedInstructionLamports(t,e,o,n){const r=g+BigInt(t),a=Buffer.alloc(8);a.writeBigUInt64LE(r);const s=a.toString("hex"),i=o.indexOf(s);if(i>=0){const t=g+n,r=Buffer.alloc(8);r.writeBigUInt64LE(t);const a=r.toString("hex"),s=o.slice(0,i)+a+o.slice(i+16);return e.data=Buffer.from(s,"hex"),!0}return!1}export function createMemoInstructionWithTxInfo(t){let e=`0x${(t.isBuy?1:2).toString(16).padStart(2,"0").toUpperCase()}`;const o=Buffer.alloc(8);o.writeBigUInt64LE(BigInt(t.amountIn));const n=o.toString("hex");o.writeBigUInt64LE(BigInt(t.amountOutMin));const r=o.toString("hex"),a=t.isBuy?t.out.address:t.in.address;return k(e+n+r+a)}export async function getDexCommisionReceiverAndLamports(t){const e=new s(B()),[o]=await s.findProgramAddress([Buffer.from(h)],e),n=1e4*Number(t.amountIn)/(1e4-t.feeRate);return{swap_pda:o,commissionAmount:t.isBuy?Math.floor(n*t.feeRate/1e4):Math.floor(Number(t.amountOutMin)*t.feeRate/1e4)}}export async function deleteTipCurrentInInstructions(t){for(let e=t.instructions.length-1;e>t.instructions.length-3;e--){const o=t.instructions[e];if(o.programId.toBase58()==N.toBase58()){o.data.readUInt32LE(0)===L&&(console.log("SOLANA_SYSTEM_PROGRAM_TRANSFER_ID"),t.instructions.splice(t.instructions.length-1))}}}export function getTipAndPriorityByUserPriorityFee(t){return{tipAmount:t-5e4,priorityAmount:5e4}}