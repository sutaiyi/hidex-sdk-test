import*as e from"@project-serum/anchor";import{Keypair as t,PublicKey as i}from"@solana/web3.js";import o from"../../common/abis";import{ETH_SERIES as n,zero as r}from"../../common/config";import{PROGRAMID as s,SEED_DATA as a}from"../sol/config";import{ethers as c}from"ethers";import{initAnchor as m}from"../sol/instruction/InstructionCreator";import{isSol as u}from"./index";class f{store;defaultFeeInfo;network;constructor(e){this.store=e.catcher,this.network=e.network,this.defaultFeeInfo={inviterDiscount:.009,dexFee:.01,inviterCommision:.025}}async execute(e){try{const t=await this.getDexFeeByChain(e);return console.log(`${e} 链上合约交易手续费率===>`,t),t.dexFee&&this.set(e,t),t||this.defaultFeeInfo}catch(e){return this.defaultFeeInfo}}async getEthDexFee(e){const t=this.network.get(e),i=new c.Contract(t.deTrade,o.chillSwapABI,this.network.getProviderByChain(e)),n=await i.callStatic.getDexCommissionRate();return{inviterDiscount:await i.callStatic.getfeeDiscountRatio()/1e4,dexFee:n/1e4,inviterCommision:await i.callStatic.getInviterCommissionRate()/1e4}}async getDexFeeByChain(r){if(-1!==n.indexOf(r))return this.getEthDexFee(r);if(r.toLowerCase()==="SOLANA".toLowerCase()){const n=t.generate();m(n,this.network);const r=new i(s),c=new e.Program(o.solanaIDL,r),[u]=await i.findProgramAddress([Buffer.from(a)],r),f=await c.account.configData.fetch(u);return{inviterDiscount:f.commisionDiscountRatio.toNumber()/1e4,dexFee:f.dexCommisionRate.toNumber()/1e4,inviterCommision:f.inviterCommisionRate.toNumber()/1e4}}return this.defaultFeeInfo}async set(e,t){return await this.store.setItem(`DexFeeInfo:${e.toLowerCase()}`,t)}async get(e){const t=await this.store.getItem(`DexFeeInfo:${e.toLowerCase()}`);if(!t){return await this.execute(e)}return t}async getDexFee(e){const t=this.network.get(e);return await this.get(t.chainName)}getAmountOut(e){return e}async getDexFeeAmount(e,t){const{isBuy:i,inviter:o,chain:n}=e,{dexFee:s,inviterDiscount:a}=await this.getDexFee(n),c=o&&o!==r?a:s;if(i){const e=Math.floor(Number(t)*c);return BigInt(e).toString()}return"0"}async getAmountOutMin(e,t){if(u(e.chain))return t;const i=e.slipPersent;if(e.isBuy){const o=await this.getDexFee(e.chain),n=e.inviter===r?o.dexFee:o.inviterDiscount,s=Math.floor(Number(t)*(1-n-i));return BigInt(s).toString()}const o=Math.floor(Number(t)*(1-i));return BigInt(o).toString()}}export default f;